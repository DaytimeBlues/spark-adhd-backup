<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Spark ‚Äî Behavioral Activation</title>
  <meta name="description" content="Break inertia. Start moving. A tool for the inattentive mind.">
  <meta name="theme-color" content="#1a1a2e">

  <!-- PWA Manifest -->
  <link rel="manifest"
    href="data:application/json,%7B%22name%22%3A%22Spark%22%2C%22short_name%22%3A%22Spark%22%2C%22start_url%22%3A%22.%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%231a1a2e%22%2C%22theme_color%22%3A%22%236200EA%22%7D">

  <!-- CDN Dependencies -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google API -->
  <script src="https://apis.google.com/js/api.js" async defer></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'caddi-purple': '#6200EA',
            'caddi-blue': '#2979FF',
            'caddi-orange': '#FF9100',
            'caddi-charcoal': '#1a1a2e',
            'caddi-dark': '#16162a',
            'caddi-light': '#fafafa',
            'caddi-cream': '#faf8f5',
          },
          fontFamily: {
            'sans': ['Inter', 'system-ui', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'sans-serif'],
          }
        }
      }
    }
  </script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');

    * {
      -webkit-tap-highlight-color: transparent;
      user-select: none;
    }

    body {
      overflow-x: hidden;
      transition: background-color 0.3s ease;
    }

    body.dark-theme {
      background: #1a1a2e;
    }

    body.light-theme {
      background: #faf8f5;
    }

    .btn-juice {
      transition: transform 0.15s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.15s ease;
    }

    .btn-juice:active {
      transform: scale(0.92);
    }

    .breathing-circle {
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .fade-in {
      animation: fadeIn 0.3s ease-out forwards;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes pulse-glow {

      0%,
      100% {
        box-shadow: 0 0 20px rgba(98, 0, 234, 0.4);
      }

      50% {
        box-shadow: 0 0 40px rgba(98, 0, 234, 0.7);
      }
    }

    .glow-pulse {
      animation: pulse-glow 2s ease-in-out infinite;
    }

    @keyframes success-burst {
      0% {
        transform: scale(0.8);
        opacity: 0;
      }

      50% {
        transform: scale(1.05);
      }

      100% {
        transform: scale(1);
        opacity: 1;
      }
    }

    .success-burst {
      animation: success-burst 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    }

    .step-reveal {
      animation: stepReveal 0.4s ease-out forwards;
    }

    @keyframes stepReveal {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }

      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes shimmer {
      0% {
        background-position: -200% center;
      }

      100% {
        background-position: 200% center;
      }
    }

    .shimmer {
      background: linear-gradient(90deg, transparent 0%, rgba(255, 255, 255, 0.2) 50%, transparent 100%);
      background-size: 200% 100%;
      animation: shimmer 2s infinite;
    }

    @keyframes float {

      0%,
      100% {
        transform: translateY(0) rotate(0deg);
      }

      50% {
        transform: translateY(-20px) rotate(5deg);
      }
    }

    .particle {
      position: absolute;
      pointer-events: none;
      border-radius: 50%;
      animation: float 4s ease-in-out infinite;
    }

    @keyframes confetti-fall {
      0% {
        transform: translateY(0) rotate(0deg);
        opacity: 1;
      }

      100% {
        transform: translateY(100vh) rotate(720deg);
        opacity: 0;
      }
    }

    .confetti {
      position: fixed;
      pointer-events: none;
      animation: confetti-fall 3s ease-out forwards;
    }

    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 4px;
    }

    ::-webkit-scrollbar-track {
      background: #16162a;
    }

    ::-webkit-scrollbar-thumb {
      background: #6200EA;
      border-radius: 2px;
    }

    .update-toast {
      backdrop-filter: blur(8px);
    }
  </style>
</head>

<body class="dark-theme">
  <div id="root"></div>
  <div id="update-toast" class="hidden fixed bottom-4 left-1/2 -translate-x-1/2 z-50 w-[calc(100%-2rem)] max-w-md">
    <div
      class="update-toast flex items-center justify-between gap-3 rounded-2xl bg-caddi-dark/90 px-4 py-3 shadow-2xl border border-white/10 text-white">
      <div>
        <p class="font-bold text-sm">Update available</p>
        <p class="text-xs opacity-80">Tap to refresh and load the latest improvements.</p>
      </div>
      <button id="update-reload"
        class="btn-juice px-4 py-2 rounded-xl bg-caddi-orange text-white font-semibold text-sm">
        Reload
      </button>
    </div>
  </div>

  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;

    // ============================================
    // STOIC & CBT WISDOM - Verified Sources Only
    // Marcus Aurelius, Seneca, Epictetus, Zeno, Cleanthes, Musonius Rufus
    // ============================================
    const STOIC_QUOTES = {
      ignite: [
        { text: "Well begun is half done.", author: "Aristotle" },
        { text: "It is not that we have a short time to live, but that we waste a lot of it.", author: "Seneca" },
        { text: "How long are you going to wait before you demand the best for yourself?", author: "Epictetus" },
        { text: "Waste no more time arguing about what a good man should be. Be one.", author: "Marcus Aurelius" },
        { text: "At dawn, when you have trouble getting out of bed, tell yourself: I have to go to work‚Äîas a human being.", author: "Marcus Aurelius" },
        { text: "While we wait for life, life passes.", author: "Seneca" },
        { text: "The soul becomes dyed with the color of its thoughts.", author: "Marcus Aurelius" },
        { text: "Putting things off is the biggest waste of life.", author: "Seneca" },
        { text: "You could leave life right now. Let that determine what you do and say and think.", author: "Marcus Aurelius" },
        { text: "Make the best use of what is in your power, and take the rest as it happens.", author: "Epictetus" },
        { text: "Begin at once to live, and count each separate day as a separate life.", author: "Seneca" },
        { text: "We are more often frightened than hurt; and we suffer more in imagination than in reality.", author: "Seneca" },
        { text: "Think of the life you have lived until now as over and, as a dead man, see what's left as a bonus.", author: "Marcus Aurelius" },
        { text: "Life is very short and anxious for those who forget the past, neglect the present, and fear the future.", author: "Seneca" },
        { text: "If you want to improve, be content to be thought foolish and stupid.", author: "Epictetus" },
      ],
      fogcutter: [
        { text: "The impediment to action advances action. What stands in the way becomes the way.", author: "Marcus Aurelius" },
        { text: "No great thing is created suddenly.", author: "Epictetus" },
        { text: "Well-being is realized by small steps, but is truly no small thing.", author: "Zeno of Citium" },
        { text: "Progress is not achieved by luck or accident, but by working on yourself daily.", author: "Epictetus" },
        { text: "Difficulties strengthen the mind, as labor does the body.", author: "Seneca" },
        { text: "The greater the difficulty, the more glory in surmounting it.", author: "Epictetus" },
        { text: "A gem cannot be polished without friction, nor a man perfected without trials.", author: "Seneca" },
        { text: "First say to yourself what you would be; then do what you have to do.", author: "Epictetus" },
        { text: "If it is not right, do not do it. If it is not true, do not say it.", author: "Marcus Aurelius" },
        { text: "We suffer more often in imagination than in reality.", author: "Seneca" },
        { text: "He who fears death will never do anything worthy of a man who is alive.", author: "Seneca" },
        { text: "Don't explain your philosophy. Embody it.", author: "Epictetus" },
        { text: "The whole future lies in uncertainty: live immediately.", author: "Seneca" },
        { text: "It is not the man who has too little that is poor, but the one who hankers after more.", author: "Seneca" },
        { text: "We should every night call ourselves to an account: What infirmity have I mastered today?", author: "Seneca" },
      ],
      anchor: [
        { text: "First say to yourself what you would be; then do what you have to do.", author: "Epictetus" },
        { text: "Confine yourself to the present.", author: "Marcus Aurelius" },
        { text: "True happiness is to enjoy the present, without anxious dependence upon the future.", author: "Seneca" },
        { text: "You have power over your mind‚Äînot outside events. Realize this, and you will find strength.", author: "Marcus Aurelius" },
        { text: "Caretake this moment. Immerse yourself in its particulars.", author: "Epictetus" },
        { text: "The mind that is anxious about future events is miserable.", author: "Seneca" },
        { text: "Never let the future disturb you.", author: "Marcus Aurelius" },
        { text: "Very little is needed to make a happy life; it is all within yourself.", author: "Marcus Aurelius" },
        { text: "He suffers more than necessary, who suffers before it is necessary.", author: "Seneca" },
        { text: "Today I escaped anxiety. Or no, I discarded it, because it was within me.", author: "Marcus Aurelius" },
        { text: "The happiness of your life depends upon the quality of your thoughts.", author: "Marcus Aurelius" },
        { text: "Wealth consists not in having great possessions, but in having few wants.", author: "Epictetus" },
        { text: "Man is not worried by real problems so much as by his imagined anxieties about real problems.", author: "Epictetus" },
        { text: "Accept the things to which fate binds you, and love the people with whom fate brings you together.", author: "Marcus Aurelius" },
        { text: "The present is the only thing of which a man can be deprived.", author: "Marcus Aurelius" },
      ],
      completion: [
        { text: "The impediment to action advances action. What stands in the way becomes the way.", author: "Marcus Aurelius" },
        { text: "Difficulty shows what men are.", author: "Epictetus" },
        { text: "We suffer more in imagination than in reality.", author: "Seneca" },
        { text: "The art of living is more like wrestling than dancing.", author: "Marcus Aurelius" },
        { text: "Progress is not achieved by luck or accident, but by working on yourself daily.", author: "Epictetus" },
        { text: "Every new beginning comes from some other beginning's end.", author: "Seneca" },
        { text: "He is a wise man who does not grieve for the things which he has not, but rejoices for those which he has.", author: "Epictetus" },
        { text: "No man is free who is not master of himself.", author: "Epictetus" },
      ]
    };

    const getRandomQuote = (category) => {
      const quotes = STOIC_QUOTES[category];
      return quotes[Math.floor(Math.random() * quotes.length)];
    };

    // ============================================
    // LOCAL STORAGE PERSISTENCE
    // ============================================
    const STORAGE_KEYS = {
      currentMode: 'spark_current_mode',
      igniteRemaining: 'spark_ignite_remaining',
      igniteStartTime: 'spark_ignite_start_time',
      igniteRunning: 'spark_ignite_running',
      igniteDuration: 'spark_ignite_duration',
      fogcutterTask: 'spark_fogcutter_task',
      fogcutterSteps: 'spark_fogcutter_steps',
      fogcutterIndex: 'spark_fogcutter_index',
      streakCount: 'spark_streak_count',
      lastUseDate: 'spark_last_use_date',
      theme: 'spark_theme',
      soundEnabled: 'spark_sound_enabled',
      breathingPattern: 'spark_breathing_pattern',
      pomodoroPhase: 'spark_pomodoro_phase',
      pomodoroRemaining: 'spark_pomodoro_remaining',
      pomodoroTarget: 'spark_pomodoro_target',
      pomodoroDuration: 'spark_pomodoro_duration',
      brainDraft: 'spark_brain_draft',
      brainQueue: 'spark_brain_queue',
      offlineQueue: 'spark_offline_queue',
      googleToken: 'spark_google_token',
    };

    const saveState = (key, value) => {
      try { localStorage.setItem(key, JSON.stringify(value)); } catch (e) { }
    };

    const loadState = (key, defaultValue) => {
      try {
        const saved = localStorage.getItem(key);
        return saved ? JSON.parse(saved) : defaultValue;
      } catch (e) { return defaultValue; }
    };

    const clearModeState = () => {
      ['igniteRemaining', 'igniteStartTime', 'igniteRunning', 'fogcutterTask', 'fogcutterSteps', 'fogcutterIndex']
        .forEach(key => localStorage.removeItem(STORAGE_KEYS[key]));
    };

    // ============================================
    // STREAK TRACKING
    // ============================================
    const updateStreak = () => {
      const today = new Date().toDateString();
      const lastUse = loadState(STORAGE_KEYS.lastUseDate, null);
      let streak = loadState(STORAGE_KEYS.streakCount, 0);

      if (lastUse === today) return streak; // Already counted today

      const yesterday = new Date(Date.now() - 86400000).toDateString();
      if (lastUse === yesterday) {
        streak += 1;
      } else if (lastUse !== today) {
        streak = 1; // Reset streak
      }

      saveState(STORAGE_KEYS.streakCount, streak);
      saveState(STORAGE_KEYS.lastUseDate, today);
      return streak;
    };

    // ============================================
    // SOUND EFFECTS (Web Audio API)
    // ============================================
    class SoundFX {
      constructor() {
        this.ctx = null;
        this.enabled = loadState(STORAGE_KEYS.soundEnabled, true);
      }

      init() {
        if (!this.ctx) {
          this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        }
      }

      playTone(frequency, duration, type = 'sine', volume = 0.3) {
        if (!this.enabled) return;
        try {
          this.init();
          const osc = this.ctx.createOscillator();
          const gain = this.ctx.createGain();
          osc.type = type;
          osc.frequency.value = frequency;
          gain.gain.setValueAtTime(volume, this.ctx.currentTime);
          gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
          osc.connect(gain);
          gain.connect(this.ctx.destination);
          osc.start();
          osc.stop(this.ctx.currentTime + duration);
        } catch (e) { }
      }

      tock() { this.playTone(800, 0.05, 'square', 0.15); }

      chime() {
        this.playTone(523, 0.3, 'sine', 0.2); // C
        setTimeout(() => this.playTone(659, 0.3, 'sine', 0.2), 100); // E
        setTimeout(() => this.playTone(784, 0.4, 'sine', 0.25), 200); // G
      }

      breathPulse() { this.playTone(130, 0.8, 'sine', 0.1); }

      achievement() {
        [523, 659, 784, 1047].forEach((f, i) =>
          setTimeout(() => this.playTone(f, 0.2, 'sine', 0.15), i * 80)
        );
      }

      toggle() {
        this.enabled = !this.enabled;
        saveState(STORAGE_KEYS.soundEnabled, this.enabled);
        if (this.enabled) this.tock();
        return this.enabled;
      }
    }

    const soundFX = new SoundFX();

    // ============================================
    // BROWN NOISE GENERATOR
    // ============================================
    class BrownNoiseGenerator {
      constructor() {
        this.audioContext = null;
        this.noiseNode = null;
        this.gainNode = null;
        this.isPlaying = false;
      }

      start() {
        if (this.isPlaying) return;
        try {
          this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
          const bufferSize = 2 * this.audioContext.sampleRate;
          const buffer = this.audioContext.createBuffer(1, bufferSize, this.audioContext.sampleRate);
          const output = buffer.getChannelData(0);

          let lastOut = 0;
          for (let i = 0; i < bufferSize; i++) {
            const white = Math.random() * 2 - 1;
            output[i] = (lastOut + (0.02 * white)) / 1.02;
            lastOut = output[i];
            output[i] *= 3.5;
          }

          this.noiseNode = this.audioContext.createBufferSource();
          this.noiseNode.buffer = buffer;
          this.noiseNode.loop = true;
          this.gainNode = this.audioContext.createGain();
          this.gainNode.gain.value = 0.3;
          this.noiseNode.connect(this.gainNode);
          this.gainNode.connect(this.audioContext.destination);
          this.gainNode.gain.setValueAtTime(0, this.audioContext.currentTime);
          this.gainNode.gain.linearRampToValueAtTime(0.3, this.audioContext.currentTime + 1);
          this.noiseNode.start();
          this.isPlaying = true;
        } catch (e) { }
      }

      stop() {
        if (!this.isPlaying) return;
        try {
          if (this.gainNode) {
            this.gainNode.gain.linearRampToValueAtTime(0, this.audioContext.currentTime + 0.5);
          }
          setTimeout(() => {
            this.noiseNode?.stop();
            this.audioContext?.close();
            this.isPlaying = false;
          }, 600);
        } catch (e) { this.isPlaying = false; }
      }
    }

    const brownNoise = new BrownNoiseGenerator();

    // ============================================
    // HAPTIC FEEDBACK
    // ============================================
    const haptic = (pattern = [50]) => {
      try { navigator.vibrate?.(pattern); } catch (e) { }
    };

    // ============================================
    // TOAST + BANNER MESSAGING
    // ============================================
    const toastBus = {
      listeners: new Set(),
      push(toast) { this.listeners.forEach(fn => fn(toast)); },
      subscribe(fn) { this.listeners.add(fn); return () => this.listeners.delete(fn); }
    };

    const pushToast = (message, tone = 'info') => {
      const id = crypto.randomUUID ? crypto.randomUUID() : `${Date.now()}-${Math.random()}`;
      toastBus.push({ id, message, tone });
    };

    const ToastHost = () => {
      const [toasts, setToasts] = useState([]);

      useEffect(() => toastBus.subscribe(toast => setToasts(prev => [...prev, toast])), []);

      useEffect(() => {
        if (toasts.length === 0) return;
        const timers = toasts.map(t => setTimeout(() =>
          setToasts(prev => prev.filter(p => p.id !== t.id)), 4000)
        );
        return () => timers.forEach(clearTimeout);
      }, [toasts]);

      return (
        <div className="fixed bottom-4 inset-x-0 flex justify-center pointer-events-none z-50">
          <div className="space-y-2 w-full max-w-md px-4">
            {toasts.map(toast => (
              <div
                key={toast.id}
                className={`p-3 rounded-xl shadow-lg text-sm font-semibold pointer-events-auto transition transform bg-caddi-dark text-white border-2 ${toast.tone === 'error' ? 'border-red-400' : 'border-caddi-purple'}`}
              >
                {toast.message}
              </div>
            ))}
          </div>
        </div>
      );
    };

    const Banner = ({ message, onClose }) => {
      if (!message) return null;
      return (
        <div className="fixed top-0 inset-x-0 bg-caddi-blue text-white text-sm font-semibold py-3 px-4 flex items-center justify-between z-40 shadow-lg">
          <span>{message}</span>
          <button onClick={onClose} className="text-white opacity-80 hover:opacity-100">‚úï</button>
        </div>
      );
    };

    // ============================================
    // NOTIFICATION + SYNC MANAGERS
    // ============================================
    const ACTION_EVENT = 'spark-notification-action';
    const emitNotificationAction = (action) => {
      window.dispatchEvent(new CustomEvent(ACTION_EVENT, { detail: action }));
    };

    const subscribeNotificationActions = (handler) => {
      const listener = (event) => handler(event.detail);
      window.addEventListener(ACTION_EVENT, listener);
      return () => window.removeEventListener(ACTION_EVENT, listener);
    };

    class NotificationManager {
      constructor() {
        this.registrationPromise = null;
        this.onDenied = null;
        this.permission = typeof Notification !== 'undefined' ? Notification.permission : 'denied';
      }

      setOnDenied(callback) { this.onDenied = callback; }

      async init() {
        if ('serviceWorker' in navigator) {
          this.registrationPromise = navigator.serviceWorker.register('./sw.js');
          navigator.serviceWorker.addEventListener('message', (event) => {
            if (event.data?.type === 'notification-action') emitNotificationAction(event.data.action);
            if (event.data?.type === 'perform-sync') offlineSync.flushQueue();
          });
        }
      }

      async ensurePermission() {
        if (typeof Notification === 'undefined') {
          this.onDenied?.('Notifications not supported in this browser.');
          pushToast('Notifications not supported here. We will keep you updated in-app.', 'error');
          return 'denied';
        }

        if (this.permission === 'granted') return 'granted';

        const permission = await Notification.requestPermission();
        this.permission = permission;
        if (permission !== 'granted') {
          this.onDenied?.('Notifications are blocked. In-app alerts enabled.');
          pushToast('Notifications blocked. We will use banners and toasts instead.', 'error');
        }
        return permission;
      }

      async showNotification(title, options) {
        const permission = await this.ensurePermission();
        if (permission !== 'granted') return;

        try {
          const registration = await this.registrationPromise;
          if (registration?.showNotification) {
            await registration.showNotification(title, options);
            return;
          }
        } catch (e) { }

        try {
          const notification = new Notification(title, options);
          notification.onclick = () => emitNotificationAction('default');
        } catch (e) { }
      }

      async sendIgniteComplete(duration) {
        const supportsActions = typeof Notification !== 'undefined' && 'actions' in Notification.prototype;
        await this.showNotification('Momentum achieved', {
          body: `Your ${duration} min focus block wrapped up.`,
          actions: supportsActions ? [
            { action: 'start-break', title: 'Start break' },
            { action: 'add-5', title: 'Add 5 min' },
          ] : [],
          data: { type: 'ignite-complete' },
        });
      }
    }

    const notificationManager = new NotificationManager();

    class OfflineSyncManager {
      constructor() {
        this.queue = loadState(STORAGE_KEYS.offlineQueue, []);
        this.retryTimer = null;
        window.addEventListener('online', () => this.flushQueue());
      }

      persist() { saveState(STORAGE_KEYS.offlineQueue, this.queue); }

      recordEdit(kind, payload) {
        this.queue.push({ kind, payload, timestamp: Date.now() });
        this.persist();
        if (navigator.onLine) {
          this.flushQueue();
        } else {
          pushToast('Saved offline. Will sync when back online.', 'info');
          this.scheduleBackgroundSync();
        }
      }

      async scheduleBackgroundSync() {
        try {
          const registration = await notificationManager.registrationPromise;
          if (registration?.sync) {
            await registration.sync.register('spark-offline-sync');
            return;
          }
        } catch (e) { }
        this.retryTimer = setTimeout(() => this.flushQueue(), 30000);
      }

      async flushQueue() {
        if (this.queue.length === 0) return;
        if (!navigator.onLine) return;

        const pending = [...this.queue];
        this.queue = [];
        this.persist();

        pending.forEach(item => {
          // Simulate remote sync; real implementation would POST to API.
          setTimeout(() => {
            pushToast(`${item.kind === 'calendar' ? 'Calendar' : 'Tasks'} refreshed.`, 'info');
          }, 500);
        });
      }
    }

    const offlineSync = new OfflineSyncManager();

    // ============================================
    // GOOGLE AUTH + TASKS/CALENDAR API
    // ============================================
    const GOOGLE_CLIENT_ID = '474078142013-5hruq35gdk11gmt7drdp0ttnl4f6pqbg.apps.googleusercontent.com';
    const GOOGLE_SCOPES = 'https://www.googleapis.com/auth/tasks https://www.googleapis.com/auth/calendar.readonly';

    class GoogleAuthManager {
      constructor() {
        this.tokenClient = null;
        this.accessToken = loadState(STORAGE_KEYS.googleToken, null);
        this.isReady = false;
        this.onAuthChange = null;
      }

      saveToken(token) {
        this.accessToken = token;
        saveState(STORAGE_KEYS.googleToken, token);
      }

      clearToken() {
        this.accessToken = null;
        localStorage.removeItem(STORAGE_KEYS.googleToken);
      }

      async init() {
        // If we have a saved token, try to restore the session
        if (this.accessToken) {
          try {
            await this.loadApis();
            this.onAuthChange?.(true);
          } catch (e) {
            // Token might be expired, clear it
            this.clearToken();
          }
        }

        return new Promise((resolve) => {
          const checkGoogle = () => {
            if (window.google?.accounts?.oauth2) {
              this.tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: GOOGLE_CLIENT_ID,
                scope: GOOGLE_SCOPES,
                callback: (tokenResponse) => {
                  if (tokenResponse.access_token) {
                    this.saveToken(tokenResponse.access_token);
                    this.loadApis();
                    this.onAuthChange?.(true);
                    pushToast('Signed in to Google!', 'info');
                  }
                },
              });
              this.isReady = true;
              resolve(true);
            } else {
              setTimeout(checkGoogle, 100);
            }
          };
          checkGoogle();
        });
      }

      async loadApis() {
        if (!window.gapi) return;
        return new Promise((resolve) => {
          gapi.load('client', async () => {
            await gapi.client.init({});
            await gapi.client.load('tasks', 'v1');
            await gapi.client.load('calendar', 'v3');
            gapi.client.setToken({ access_token: this.accessToken });
            resolve();
          });
        });
      }

      signIn() {
        if (!this.tokenClient) {
          pushToast('Google API not ready. Please try again.', 'error');
          return;
        }
        this.tokenClient.requestAccessToken();
      }

      signOut() {
        if (this.accessToken) {
          google.accounts.oauth2.revoke(this.accessToken);
          this.clearToken();
          this.onAuthChange?.(false);
          pushToast('Signed out of Google.', 'info');
        }
      }

      isSignedIn() {
        return Boolean(this.accessToken);
      }

      async createTask(title, due, notes) {
        if (!this.isSignedIn()) {
          throw new Error('Not signed in');
        }

        const response = await gapi.client.tasks.tasks.insert({
          tasklist: '@default',
          resource: {
            title,
            due: due || undefined,
            notes: notes || 'Created from Spark ‚Äî Brain Dump',
          },
        });
        return response.result;
      }

      async getTodayEvents() {
        if (!this.isSignedIn()) {
          throw new Error('Not signed in');
        }

        const now = new Date();
        const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate()).toISOString();
        const endOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1).toISOString();

        const response = await gapi.client.calendar.events.list({
          calendarId: 'primary',
          timeMin: startOfDay,
          timeMax: endOfDay,
          singleEvents: true,
          orderBy: 'startTime',
          maxResults: 20,
        });
        return response.result.items || [];
      }
    }

    const googleAuth = new GoogleAuthManager();

    // ============================================
    // CONFETTI PARTICLES
    // ============================================
    const Confetti = ({ active }) => {
      const [particles, setParticles] = useState([]);

      useEffect(() => {
        if (!active) return;
        const colors = ['#6200EA', '#2979FF', '#FF9100', '#fafafa'];
        const newParticles = Array.from({ length: 50 }, (_, i) => ({
          id: i,
          x: Math.random() * 100,
          color: colors[Math.floor(Math.random() * colors.length)],
          delay: Math.random() * 0.5,
          size: 8 + Math.random() * 8,
        }));
        setParticles(newParticles);
        setTimeout(() => setParticles([]), 3500);
      }, [active]);

      return (
        <>
          {particles.map(p => (
            <div
              key={p.id}
              className="confetti"
              style={{
                left: `${p.x}%`,
                top: -20,
                width: p.size,
                height: p.size,
                background: p.color,
                borderRadius: Math.random() > 0.5 ? '50%' : '2px',
                animationDelay: `${p.delay}s`,
              }}
            />
          ))}
        </>
      );
    };

    // ============================================
    // AMBIENT PARTICLES
    // ============================================
    const AmbientParticles = () => {
      const particles = Array.from({ length: 8 }, (_, i) => ({
        id: i,
        x: 10 + Math.random() * 80,
        y: 10 + Math.random() * 80,
        size: 4 + Math.random() * 6,
        delay: Math.random() * 4,
        duration: 3 + Math.random() * 3,
      }));

      return (
        <div className="fixed inset-0 pointer-events-none overflow-hidden">
          {particles.map(p => (
            <div
              key={p.id}
              className="particle bg-caddi-purple opacity-20"
              style={{
                left: `${p.x}%`,
                top: `${p.y}%`,
                width: p.size,
                height: p.size,
                animationDelay: `${p.delay}s`,
                animationDuration: `${p.duration}s`,
              }}
            />
          ))}
        </div>
      );
    };

    // ============================================
    // TASK BREAKDOWN HEURISTIC
    // ============================================
    const breakdownTask = (task) => {
      const trimmed = task.trim();
      if (!trimmed) return [];

      const words = trimmed.split(/\s+/);
      const hasVerb = /^(write|create|build|make|do|finish|complete|send|call|email|fix|clean|organize|prepare|review|read|check|update|set|get|find|buy|schedule|plan|start|begin)/i.test(trimmed);

      const steps = [];
      steps.push(`Clear your space. Close unnecessary tabs. Phone face-down.`);

      if (hasVerb) {
        const object = words.slice(1, 4).join(' ') || 'the task';
        steps.push(`Open/gather what you need for: ${object}`);
      } else {
        steps.push(`Identify the first physical action for: "${trimmed.slice(0, 30)}..."`);
      }

      steps.push(`Do ONLY the first 2 minutes of the actual work. Nothing more.`);
      steps.push(`Pause. Notice: you've started. The hardest part is done.`);

      if (words.length > 5) {
        steps.push(`Continue with the next natural chunk, or stop here. Both are valid.`);
      } else {
        steps.push(`Complete the remaining work, or schedule it. You've broken through.`);
      }

      return steps;
    };

    // ============================================
    // BREATHING PATTERNS
    // ============================================
    const BREATHING_PATTERNS = {
      calm: { name: '4-7-8 Calm', inhale: 4, hold: 7, exhale: 8, description: 'Calming breath' },
      box: { name: 'Box Breathing', inhale: 4, hold: 4, exhale: 4, holdAfter: 4, description: 'Focus & reset' },
      energize: { name: 'Energize', inhale: 2, hold: 0, exhale: 2, description: 'Quick energy' },
    };

    // ============================================
    // TIMER DURATIONS
    // ============================================
    const TIMER_OPTIONS = [2, 5, 10, 15]; // minutes

    const POMODORO_PRESETS = [
      { label: '25/5', focusMin: 25, breakMin: 5 },
      { label: '50/10', focusMin: 50, breakMin: 10 },
      { label: '15/3', focusMin: 15, breakMin: 3 },
    ];

    const getPomodoroMs = (presetIndex) => {
      const preset = POMODORO_PRESETS[presetIndex] || POMODORO_PRESETS[0];
      return { focusMs: preset.focusMin * 60 * 1000, breakMs: preset.breakMin * 60 * 1000 };
    };

    const POMODORO_DEFAULTS = getPomodoroMs(0); // legacy compatibility

    const getInitialPomodoroState = () => {
      const savedPhase = loadState(STORAGE_KEYS.pomodoroPhase, 'focus');
      const savedRemaining = loadState(STORAGE_KEYS.pomodoroRemaining, POMODORO_DEFAULTS.focusMs);
      const savedTarget = loadState(STORAGE_KEYS.pomodoroTarget, null);

      let phase = savedPhase;
      let remainingMs = savedRemaining;
      let targetEnd = savedTarget;

      if (targetEnd) {
        const now = Date.now();
        const diff = targetEnd - now;

        if (diff > 0) {
          remainingMs = diff;
        } else {
          if (phase === 'focus') {
            const overtime = Math.abs(diff);
            if (overtime < POMODORO_DEFAULTS.breakMs) {
              phase = 'break';
              remainingMs = POMODORO_DEFAULTS.breakMs - overtime;
              targetEnd = now + remainingMs;
            } else {
              phase = 'finished';
              remainingMs = 0;
              targetEnd = null;
            }
          } else if (phase === 'break') {
            phase = 'finished';
            remainingMs = 0;
            targetEnd = null;
          } else {
            phase = 'finished';
            remainingMs = 0;
            targetEnd = null;
          }
        }
      }

      return { phase, remainingMs, targetEnd };
    };

    // ============================================
    // COMPONENTS
    // ============================================

    // Home Card Component
    const HomeCard = ({ icon, title, subtitle, color, onClick }) => {
      const colorClasses = {
        purple: 'bg-caddi-purple hover:bg-purple-600 border-purple-400',
        blue: 'bg-caddi-blue hover:bg-blue-500 border-blue-300',
        orange: 'bg-caddi-orange hover:bg-orange-500 border-orange-300',
      };

      return (
        <button
          onClick={() => { haptic(); onClick(); }}
          className={`btn-juice w-full p-6 rounded-2xl ${colorClasses[color]} 
            border-2 border-opacity-30 text-white text-left
            shadow-lg hover:shadow-2xl transition-all duration-200
            min-h-[100px] flex flex-col justify-center gap-2`}
        >
          <div className="flex items-center gap-3">
            <span className="text-3xl">{icon}</span>
            <span className="text-xl font-bold tracking-tight">{title}</span>
          </div>
          <p className="text-sm opacity-80 font-medium">{subtitle}</p>
        </button>
      );
    };

    // Quote Display Component
    const QuoteDisplay = ({ quote, isDark = true }) => (
      <div className="text-center px-6 py-4 fade-in">
        <p className={`text-sm italic opacity-80 ${isDark ? 'text-caddi-light' : 'text-caddi-charcoal'}`}>"{quote.text}"</p>
        <p className="text-caddi-purple text-xs mt-2 font-semibold">‚Äî {quote.author}</p>
      </div>
    );

    // Sound Toggle Component
    const SoundToggle = ({ isDark }) => {
      const [enabled, setEnabled] = useState(soundFX.enabled);
      return (
        <button
          onClick={() => setEnabled(soundFX.toggle())}
          className={`absolute top-6 right-6 text-sm font-medium opacity-50 hover:opacity-100 ${isDark ? 'text-caddi-light' : 'text-caddi-charcoal'}`}
        >
          {enabled ? 'üîä' : 'üîá'}
        </button>
      );
    };

    // Home View
    const HomeView = ({ setMode, isDark, toggleTheme }) => {
      const streak = loadState(STORAGE_KEYS.streakCount, 0);
      const hasPomodoroSession = () => {
        const phase = loadState(STORAGE_KEYS.pomodoroPhase, 'focus');
        const target = loadState(STORAGE_KEYS.pomodoroTarget, null);
        return target && phase !== 'finished';
      };

      return (
        <div className={`min-h-screen flex flex-col justify-center p-6 fade-in ${isDark ? 'bg-caddi-charcoal' : 'bg-caddi-cream'}`}>
          <AmbientParticles />
          <SoundToggle isDark={isDark} />

          <div className="max-w-md mx-auto w-full relative z-10">
            <div className="text-center mb-10">
              <h1
                className={`text-4xl font-black tracking-tight cursor-pointer ${isDark ? 'text-caddi-light' : 'text-caddi-charcoal'}`}
                onDoubleClick={toggleTheme}
                title="Double-click to toggle theme"
              >
                <span className="text-caddi-purple">‚ö°</span> SPARK
              </h1>
              <p className={`opacity-60 mt-2 text-sm font-medium ${isDark ? 'text-caddi-light' : 'text-caddi-charcoal'}`}>
                What's blocking you?
              </p>
              {streak > 0 && (
                <p className="text-caddi-orange text-xs mt-2 font-bold">
                  üî• {streak} day{streak !== 1 ? 's' : ''} streak
                </p>
              )}
            </div>

            <div className="space-y-4">
              <HomeCard
                icon="üî•"
                title="I CAN'T START"
                subtitle="Ignite ‚Äî Momentum burst"
                color="purple"
                onClick={() => setMode('ignite')}
              />
              <HomeCard
                icon="üî™"
                title="IT'S TOO BIG"
                subtitle="Fog Cutter ‚Äî Break it down"
                color="blue"
                onClick={() => setMode('fogcutter')}
              />
              <HomeCard
                icon="‚è±Ô∏è"
                title="POMODORO"
                subtitle="Focus/Break cadence"
                color="orange"
                onClick={() => setMode('pomodoro')}
              />
              {hasPomodoroSession() && (
                <button
                  onClick={() => setMode('pomodoro')}
                  className="w-full text-xs text-caddi-orange font-semibold underline underline-offset-4 opacity-80 hover:opacity-100"
                >
                  Resume last session ‚Üí
                </button>
              )}
              <HomeCard
                icon="üß†"
                title="MY HEAD IS NOISY"
                subtitle="Brain Dump ‚Äî Capture and convert"
                color="purple"
                onClick={() => setMode('brain')}
              />
              <HomeCard
                icon="üìÖ"
                title="WHAT'S ON TODAY?"
                subtitle="Calendar ‚Äî Beat time blindness"
                color="blue"
                onClick={() => setMode('calendar')}
              />
              <HomeCard
                icon="‚öì"
                title="I'M DRIFTING"
                subtitle="Anchor ‚Äî Return to now"
                color="orange"
                onClick={() => setMode('anchor')}
              />
            </div>

            <QuoteDisplay quote={getRandomQuote('ignite')} isDark={isDark} />
          </div>
        </div>
      );
    };

    // Calendar View (Today's Schedule)
    const CalendarView = ({ setMode }) => {
      const [events, setEvents] = useState([]);
      const [isLoading, setIsLoading] = useState(false);
      const [isSignedIn, setIsSignedIn] = useState(() => googleAuth.isSignedIn());
      const [quote] = useState(() => getRandomQuote('ignite'));

      useEffect(() => {
        googleAuth.onAuthChange = (signedIn) => {
          setIsSignedIn(signedIn);
          if (signedIn) loadEvents();
        };
        if (googleAuth.isSignedIn()) loadEvents();
      }, []);

      const loadEvents = async () => {
        setIsLoading(true);
        try {
          const todayEvents = await googleAuth.getTodayEvents();
          setEvents(todayEvents);
        } catch (e) {
          pushToast('Could not load calendar events.', 'error');
        } finally {
          setIsLoading(false);
        }
      };

      const handleSignIn = () => {
        googleAuth.signIn();
      };

      const formatTime = (dateTime, date) => {
        if (!dateTime && date) return 'All day';
        const d = new Date(dateTime);
        return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      };

      const exitToHome = () => setMode('home');

      return (
        <div className="min-h-screen bg-caddi-charcoal flex flex-col justify-center items-center p-6 fade-in">
          <button
            onClick={exitToHome}
            className="absolute top-6 left-6 text-caddi-light opacity-50 hover:opacity-100 text-sm font-medium"
          >
            ‚Üê Exit
          </button>
          <SoundToggle isDark={true} />

          <div className="w-full max-w-md text-left space-y-6">
            <div className="space-y-2">
              <p className="text-caddi-blue text-sm font-bold tracking-widest">TODAY'S SCHEDULE</p>
              <h2 className="text-3xl font-black text-white leading-tight">What's on today?</h2>
              <p className="text-caddi-light opacity-70 text-sm">Beat time blindness. Know your anchors.</p>
            </div>

            {!isSignedIn ? (
              <div className="bg-caddi-dark border border-white/5 rounded-2xl p-6 text-center space-y-4">
                <p className="text-caddi-light opacity-80 text-sm">Connect Google Calendar to see today's events.</p>
                <button
                  onClick={handleSignIn}
                  className="btn-juice w-full py-4 bg-caddi-blue text-white font-bold text-lg rounded-xl shadow-lg"
                >
                  Sign in with Google
                </button>
              </div>
            ) : (
              <div className="space-y-4">
                {isLoading ? (
                  <div className="text-center py-8">
                    <div className="text-caddi-light opacity-50">Loading events...</div>
                  </div>
                ) : events.length === 0 ? (
                  <div className="bg-caddi-dark border border-white/5 rounded-2xl p-6 text-center">
                    <div className="text-4xl mb-3">üì≠</div>
                    <p className="text-caddi-light opacity-70">No events today. Clear schedule!</p>
                  </div>
                ) : (
                  <div className="space-y-3">
                    {events.map((event) => (
                      <div
                        key={event.id}
                        className="bg-caddi-dark border border-white/5 rounded-xl p-4 flex items-start gap-3"
                      >
                        <div className="text-caddi-blue font-bold text-sm min-w-[60px]">
                          {formatTime(event.start?.dateTime, event.start?.date)}
                        </div>
                        <div className="flex-1">
                          <div className="text-white font-semibold text-sm">{event.summary || 'Untitled event'}</div>
                          {event.location && (
                            <div className="text-caddi-light/60 text-xs mt-1">üìç {event.location}</div>
                          )}
                        </div>
                      </div>
                    ))}
                  </div>
                )}

                <button
                  onClick={loadEvents}
                  disabled={isLoading}
                  className="w-full py-2 text-caddi-blue text-sm font-semibold"
                >
                  ‚Üª Refresh
                </button>
              </div>
            )}

            <QuoteDisplay quote={quote} />
          </div>
        </div>
      );
    };

    // Brain Dump View
    const BrainDumpView = ({ setMode }) => {
      const [entry, setEntry] = useState(() => loadState(STORAGE_KEYS.brainDraft, ''));
      const [dueDate, setDueDate] = useState('');
      const [status, setStatus] = useState(null);
      const [queue, setQueue] = useState(() => loadState(STORAGE_KEYS.brainQueue, []));
      const [isSyncing, setIsSyncing] = useState(false);
      const [isSignedIn, setIsSignedIn] = useState(() => googleAuth.isSignedIn());
      const [quote] = useState(() => getRandomQuote('fogcutter'));

      useEffect(() => {
        googleAuth.onAuthChange = (signedIn) => setIsSignedIn(signedIn);
        return () => { googleAuth.onAuthChange = null; };
      }, []);

      useEffect(() => { saveState(STORAGE_KEYS.brainDraft, entry); }, [entry]);
      useEffect(() => { saveState(STORAGE_KEYS.brainQueue, queue); }, [queue]);

      const resetForm = () => {
        setEntry('');
        setDueDate('');
      };

      const queueTask = (task, message) => {
        const updatedQueue = [...queue, task];
        setQueue(updatedQueue);
        setStatus({ type: 'warning', message: message || 'Saved offline. Will sync when online.' });
        resetForm();
      };

      const pushToGoogleTasks = useCallback(async (task) => {
        if (!navigator.onLine) {
          queueTask(task);
          return;
        }

        if (!window.gapi?.client?.tasks?.tasks?.insert) {
          queueTask(task, 'Google Tasks not ready. Queued for sync.');
          return;
        }

        try {
          setIsSyncing(true);
          await window.gapi.client.tasks.tasks.insert({
            tasklist: '@default',
            resource: {
              title: task.title,
              due: task.due || undefined,
              notes: task.notes,
            },
          });
          setStatus({ type: 'success', message: 'Task created in your Google Tasks list.' });
          resetForm();
        } catch (e) {
          queueTask(task, 'Could not reach Google Tasks. Saved offline.');
        } finally {
          setIsSyncing(false);
        }
      }, [queue]);

      const syncQueuedTasks = useCallback(async () => {
        if (!navigator.onLine || queue.length === 0) return;
        if (!window.gapi?.client?.tasks?.tasks?.insert) return;

        setIsSyncing(true);
        const remaining = [];

        for (const task of queue) {
          try {
            await window.gapi.client.tasks.tasks.insert({
              tasklist: '@default',
              resource: {
                title: task.title,
                due: task.due || undefined,
                notes: task.notes,
              },
            });
          } catch (e) {
            remaining.push(task);
          }
        }

        setQueue(remaining);
        setIsSyncing(false);

        if (remaining.length === 0) {
          setStatus({ type: 'success', message: 'Queued dumps synced to Google Tasks.' });
        } else {
          setStatus({ type: 'warning', message: 'Some items are still queued. Check your connection.' });
        }
      }, [queue]);

      useEffect(() => {
        window.addEventListener('online', syncQueuedTasks);
        return () => window.removeEventListener('online', syncQueuedTasks);
      }, [syncQueuedTasks]);

      useEffect(() => { syncQueuedTasks(); }, [syncQueuedTasks]);

      const handleConvert = () => {
        if (!entry.trim()) {
          setStatus({ type: 'error', message: 'Add a thought before converting.' });
          return;
        }

        const due = dueDate ? new Date(dueDate).toISOString() : null;
        const payload = {
          title: entry.trim(),
          due,
          notes: 'Captured from Spark ‚Äî Brain Dump',
          createdAt: Date.now(),
        };

        haptic([40]);
        pushToGoogleTasks(payload);
      };

      const exitToHome = () => setMode('home');

      const statusStyles = {
        success: 'bg-green-500/20 text-green-200 border border-green-500/40',
        warning: 'bg-amber-500/20 text-amber-200 border border-amber-500/40',
        error: 'bg-red-500/20 text-red-100 border border-red-500/40',
      };

      return (
        <div className="min-h-screen bg-caddi-charcoal flex flex-col justify-center items-center p-6 fade-in">
          <button
            onClick={exitToHome}
            className="absolute top-6 left-6 text-caddi-light opacity-50 hover:opacity-100 text-sm font-medium"
          >
            ‚Üê Exit
          </button>
          <SoundToggle isDark={true} />

          <div className="w-full max-w-md text-left space-y-6">
            <div className="space-y-2">
              <p className="text-caddi-purple text-sm font-bold tracking-widest">BRAIN DUMP</p>
              <h2 className="text-3xl font-black text-white leading-tight">Unload everything.</h2>
              <p className="text-caddi-light opacity-70 text-sm">Drop the noise, then turn it into action.</p>
            </div>

            {/* Google Sign-in Button */}
            <div className="flex items-center justify-between bg-caddi-dark/50 border border-white/5 rounded-xl px-4 py-3">
              {isSignedIn ? (
                <>
                  <span className="text-sm text-green-400 font-medium">‚úì Connected to Google Tasks</span>
                  <button
                    onClick={() => googleAuth.signOut()}
                    className="text-xs text-caddi-light/60 hover:text-white"
                  >
                    Sign out
                  </button>
                </>
              ) : (
                <>
                  <span className="text-sm text-caddi-light/70">Sign in to sync with Google Tasks</span>
                  <button
                    onClick={() => googleAuth.signIn()}
                    className="px-3 py-1.5 bg-caddi-blue text-white text-xs font-semibold rounded-lg"
                  >
                    Sign in
                  </button>
                </>
              )}
            </div>

            {!navigator.onLine && (
              <div className="text-xs text-amber-200 bg-amber-500/20 border border-amber-500/40 px-3 py-2 rounded-xl flex items-center gap-2">
                <span>‚ö†Ô∏è Offline ‚Äî new dumps will queue for sync.</span>
              </div>
            )}

            <div className="space-y-4 bg-caddi-dark border border-white/5 rounded-2xl p-4 shadow-lg">
              <textarea
                value={entry}
                onChange={(e) => setEntry(e.target.value)}
                placeholder="What's buzzing?"
                className="w-full h-32 bg-caddi-charcoal text-white rounded-xl p-4 focus:outline-none focus:ring-2 focus:ring-caddi-purple placeholder:text-caddi-light/50"
              />

              <div className="space-y-2">
                <label className="text-xs text-caddi-light/70 font-semibold">Optional due date/time</label>
                <input
                  type="datetime-local"
                  value={dueDate}
                  onChange={(e) => setDueDate(e.target.value)}
                  className="w-full bg-caddi-charcoal text-white rounded-xl p-3 focus:outline-none focus:ring-2 focus:ring-caddi-purple"
                />
              </div>

              <button
                onClick={handleConvert}
                className="btn-juice w-full py-4 bg-caddi-purple text-white font-bold text-lg rounded-xl shadow-lg hover:shadow-2xl"
                disabled={isSyncing}
              >
                {isSyncing ? 'Syncing‚Ä¶' : 'Convert to Task'}
              </button>

              {status && (
                <div className={`text-sm rounded-xl px-4 py-3 ${statusStyles[status.type] || ''}`}>
                  {status.message}
                </div>
              )}
            </div>

            <div className="bg-caddi-dark/70 border border-white/5 rounded-2xl p-4 space-y-2">
              <div className="flex items-center justify-between text-sm text-caddi-light/80">
                <span>Offline queue</span>
                <span>{queue.length} item{queue.length === 1 ? '' : 's'}</span>
              </div>
              {queue.length === 0 ? (
                <p className="text-caddi-light/60 text-sm">Nothing waiting. You're clear.</p>
              ) : (
                <ul className="space-y-2 max-h-32 overflow-y-auto">
                  {queue.map((task) => (
                    <li
                      key={task.createdAt}
                      className="text-sm text-white bg-caddi-charcoal rounded-xl px-3 py-2 border border-white/5"
                    >
                      <div className="font-semibold">{task.title}</div>
                      {task.due && (
                        <div className="text-xs text-caddi-light/70">Due {new Date(task.due).toLocaleString()}</div>
                      )}
                    </li>
                  ))}
                </ul>
              )}
            </div>

            <QuoteDisplay quote={quote} />
          </div>
        </div>
      );
    };

    // Pomodoro View
    const PomodoroView = ({ setMode }) => {
      const [presetIndex, setPresetIndex] = useState(() => loadState(STORAGE_KEYS.pomodoroDuration, 0));
      const durations = getPomodoroMs(presetIndex);

      const initial = getInitialPomodoroState();
      const [phase, setPhase] = useState(initial.phase);
      const [remainingMs, setRemainingMs] = useState(initial.remainingMs);
      const [targetEnd, setTargetEnd] = useState(initial.targetEnd);
      const [quote] = useState(() => getRandomQuote('ignite'));
      const [isRunning, setIsRunning] = useState(() => Boolean(initial.targetEnd && initial.phase !== 'finished'));
      const [isPaused, setIsPaused] = useState(false);
      const [pausedAt, setPausedAt] = useState(null);

      useEffect(() => {
        saveState(STORAGE_KEYS.pomodoroPhase, phase);
        saveState(STORAGE_KEYS.pomodoroRemaining, remainingMs);
        saveState(STORAGE_KEYS.pomodoroTarget, targetEnd);
        saveState(STORAGE_KEYS.pomodoroDuration, presetIndex);
      }, [phase, remainingMs, targetEnd, presetIndex]);

      const advancePhase = useCallback(() => {
        if (phase === 'focus') {
          const nextTarget = Date.now() + durations.breakMs;
          setPhase('break');
          setRemainingMs(durations.breakMs);
          setTargetEnd(nextTarget);
          soundFX.tock();
          pushToast('Break time! Take a rest.', 'info');
        } else {
          setPhase('finished');
          setRemainingMs(0);
          setTargetEnd(null);
          setIsRunning(false);
          setIsPaused(false);
          soundFX.chime();
          updateStreak();
          pushToast('Pomodoro complete! Great focus.', 'info');
        }
      }, [phase, durations]);

      useEffect(() => {
        if (!isRunning || isPaused || !targetEnd || phase === 'finished') return;

        const interval = setInterval(() => {
          const now = Date.now();
          const diff = targetEnd - now;

          if (diff <= 0) {
            setRemainingMs(0);
            advancePhase();
          } else {
            setRemainingMs(diff);
          }
        }, 1000);

        return () => clearInterval(interval);
      }, [isRunning, isPaused, targetEnd, phase, advancePhase]);

      const startFocus = () => {
        const nextTarget = Date.now() + durations.focusMs;
        setPhase('focus');
        setRemainingMs(durations.focusMs);
        setTargetEnd(nextTarget);
        setIsRunning(true);
        setIsPaused(false);
        soundFX.tock();
        haptic([50]);
      };

      const startBreak = () => {
        const nextTarget = Date.now() + durations.breakMs;
        setPhase('break');
        setRemainingMs(durations.breakMs);
        setTargetEnd(nextTarget);
        setIsRunning(true);
        setIsPaused(false);
        soundFX.tock();
        haptic([50]);
      };

      const pauseTimer = () => {
        setPausedAt(Date.now());
        setIsPaused(true);
        haptic([30]);
      };

      const resumeTimer = () => {
        if (pausedAt && remainingMs > 0) {
          const newTarget = Date.now() + remainingMs;
          setTargetEnd(newTarget);
        }
        setIsPaused(false);
        setPausedAt(null);
        haptic([30]);
      };

      const resetPomodoro = () => {
        setPhase('focus');
        setRemainingMs(durations.focusMs);
        setTargetEnd(null);
        setIsRunning(false);
        setIsPaused(false);
        setPausedAt(null);
      };

      const cycleDuration = () => {
        if (isRunning) return;
        const nextIndex = (presetIndex + 1) % POMODORO_PRESETS.length;
        setPresetIndex(nextIndex);
        const newDurations = getPomodoroMs(nextIndex);
        setRemainingMs(phase === 'focus' ? newDurations.focusMs : newDurations.breakMs);
        haptic([40]);
      };

      const formatMs = (ms) => {
        const totalSeconds = Math.max(0, Math.floor(ms / 1000));
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = totalSeconds % 60;
        return `${minutes}:${seconds.toString().padStart(2, '0')}`;
      };

      const statusLabel = {
        focus: isPaused ? 'Focus (paused)' : 'Focus sprint',
        break: isPaused ? 'Break (paused)' : 'Break time',
        finished: 'Session complete',
      }[phase];

      const currentPreset = POMODORO_PRESETS[presetIndex];
      const totalMs = phase === 'break' ? durations.breakMs : durations.focusMs;
      const progress = Math.min(100, (1 - (remainingMs / totalMs)) * 100);

      const exitToHome = () => { setMode('home'); };

      return (
        <div className="min-h-screen bg-caddi-dark flex flex-col justify-center items-center p-6 fade-in">
          <button
            onClick={exitToHome}
            className="absolute top-6 left-6 text-caddi-light opacity-50 hover:opacity-100 text-sm font-medium"
          >
            ‚Üê Exit
          </button>
          <SoundToggle isDark={true} />

          <div className="text-center max-w-md w-full">
            <h2 className="text-caddi-orange text-sm font-bold tracking-widest mb-1">POMODORO</h2>

            {/* Duration Selector */}
            <button
              onClick={cycleDuration}
              disabled={isRunning}
              className={`text-xs font-semibold px-3 py-1 rounded-full mb-4 transition ${isRunning
                ? 'bg-caddi-charcoal text-caddi-light/50 cursor-not-allowed'
                : 'bg-caddi-purple/20 text-caddi-purple hover:bg-caddi-purple/30'
                }`}
            >
              {currentPreset.label} min ‚Ä¢ tap to change
            </button>

            <p className="text-caddi-light opacity-70 mb-6 text-sm">{statusLabel}</p>

            <div className={`text-8xl font-black mb-4 tracking-tight transition-colors ${isPaused ? 'text-caddi-light/50' : 'text-white'}`}>
              {formatMs(remainingMs || durations.focusMs)}
            </div>

            <div className="w-full h-2 bg-caddi-charcoal rounded-full overflow-hidden mb-8">
              <div
                className={`h-full transition-all duration-500 ease-linear ${isPaused ? 'bg-caddi-light/30' : 'bg-gradient-to-r from-caddi-purple to-caddi-orange'
                  }`}
                style={{ width: `${progress}%` }}
              />
            </div>

            <QuoteDisplay quote={quote} />

            <div className="space-y-3 mt-6">
              {/* Not running - show start buttons */}
              {phase === 'focus' && !isRunning && (
                <button
                  onClick={startFocus}
                  className="btn-juice w-full py-4 bg-caddi-purple text-white font-bold text-lg rounded-xl shadow-lg shimmer"
                >
                  Start Focus
                </button>
              )}
              {phase === 'break' && !isRunning && (
                <button
                  onClick={startBreak}
                  className="btn-juice w-full py-4 bg-caddi-blue text-white font-bold text-lg rounded-xl shadow-lg"
                >
                  Start Break
                </button>
              )}

              {/* Running - show pause/resume */}
              {isRunning && !isPaused && phase !== 'finished' && (
                <button
                  onClick={pauseTimer}
                  className="btn-juice w-full py-4 bg-caddi-charcoal border-2 border-caddi-orange text-caddi-orange font-bold text-lg rounded-xl"
                >
                  ‚è∏ Pause
                </button>
              )}
              {isRunning && isPaused && phase !== 'finished' && (
                <button
                  onClick={resumeTimer}
                  className="btn-juice w-full py-4 bg-caddi-orange text-white font-bold text-lg rounded-xl shadow-lg shimmer"
                >
                  ‚ñ∂ Resume
                </button>
              )}

              {/* Session finished */}
              {phase === 'finished' && (
                <>
                  <p className="text-caddi-light opacity-70 text-sm">Great work! Ready for another?</p>
                  <button
                    onClick={resetPomodoro}
                    className="btn-juice w-full py-3 bg-caddi-purple text-white font-bold rounded-xl"
                  >
                    Start New Session
                  </button>
                </>
              )}

              {/* Reset button when running */}
              {isRunning && (
                <button
                  onClick={resetPomodoro}
                  className="w-full py-2 text-caddi-light/50 hover:text-caddi-light text-sm font-medium"
                >
                  Reset
                </button>
              )}
            </div>
          </div>
        </div>
      );
    };

    // Ignite Timer View
    const IgniteView = ({ setMode }) => {
      const [selectedDuration, setSelectedDuration] = useState(() =>
        loadState(STORAGE_KEYS.igniteDuration, 5)
      );
      const TOTAL_TIME = selectedDuration * 60;

      const [remaining, setRemaining] = useState(() => {
        const saved = loadState(STORAGE_KEYS.igniteRemaining, null);
        const wasRunning = loadState(STORAGE_KEYS.igniteRunning, false);
        const startTime = loadState(STORAGE_KEYS.igniteStartTime, null);

        if (wasRunning && startTime) {
          const elapsed = Math.floor((Date.now() - startTime) / 1000);
          return Math.max(0, TOTAL_TIME - elapsed);
        }
        return saved !== null ? saved : TOTAL_TIME;
      });

      const [isRunning, setIsRunning] = useState(() => loadState(STORAGE_KEYS.igniteRunning, false));
      const [isComplete, setIsComplete] = useState(false);
      const [showConfetti, setShowConfetti] = useState(false);
      const [quote] = useState(() => getRandomQuote('ignite'));

      useEffect(() => {
        if (isRunning && !isComplete) {
          brownNoise.start();
          saveState(STORAGE_KEYS.igniteRunning, true);
          if (!loadState(STORAGE_KEYS.igniteStartTime, null)) {
            saveState(STORAGE_KEYS.igniteStartTime, Date.now() - ((TOTAL_TIME - remaining) * 1000));
          }
        }
        return () => { if (!isRunning) brownNoise.stop(); };
      }, [isRunning]);

      useEffect(() => {
        if (!isComplete) return;
        notificationManager.sendIgniteComplete(selectedDuration);
        offlineSync.recordEdit('calendar', { type: 'ignite-session', duration: selectedDuration });
      }, [isComplete, selectedDuration]);

      useEffect(() => subscribeNotificationActions((action) => {
        if (action === 'start-break') {
          exitToHome();
          setMode('anchor');
        }
        if (action === 'add-5') {
          const newDuration = selectedDuration + 5;
          setSelectedDuration(newDuration);
          setRemaining(newDuration * 60);
          setIsComplete(false);
          setShowConfetti(false);
          setIsRunning(true);
          saveState(STORAGE_KEYS.igniteDuration, newDuration);
          saveState(STORAGE_KEYS.igniteRemaining, newDuration * 60);
          saveState(STORAGE_KEYS.igniteRunning, true);
          saveState(STORAGE_KEYS.igniteStartTime, Date.now());
        }
      }), [selectedDuration]);

      useEffect(() => {
        if (!isRunning || isComplete) return;

        const interval = setInterval(() => {
          setRemaining(prev => {
            const next = prev - 1;
            saveState(STORAGE_KEYS.igniteRemaining, next);

            if (next <= 0) {
              setIsComplete(true);
              setIsRunning(false);
              setShowConfetti(true);
              brownNoise.stop();
              soundFX.chime();
              updateStreak();
              clearModeState();
              return 0;
            }
            return next;
          });
        }, 1000);

        return () => clearInterval(interval);
      }, [isRunning, isComplete]);

      const cycleDuration = () => {
        if (isRunning) return;
        const idx = TIMER_OPTIONS.indexOf(selectedDuration);
        const newDuration = TIMER_OPTIONS[(idx + 1) % TIMER_OPTIONS.length];
        setSelectedDuration(newDuration);
        setRemaining(newDuration * 60);
        saveState(STORAGE_KEYS.igniteDuration, newDuration);
        haptic();
      };

      const startTimer = () => {
        notificationManager.ensurePermission();
        setIsComplete(false);
        setShowConfetti(false);
        setIsRunning(true);
        saveState(STORAGE_KEYS.igniteRemaining, remaining);
        saveState(STORAGE_KEYS.igniteRunning, true);
        saveState(STORAGE_KEYS.igniteStartTime, Date.now());
        haptic([100]);
      };

      const exitToHome = () => {
        brownNoise.stop();
        clearModeState();
        setMode('home');
      };

      const keepGoing = () => {
        setRemaining(selectedDuration * 60);
        setIsComplete(false);
        setShowConfetti(false);
        setIsRunning(true);
        saveState(STORAGE_KEYS.igniteStartTime, Date.now());
      };

      const minutes = Math.floor(remaining / 60);
      const seconds = remaining % 60;
      const progress = ((TOTAL_TIME - remaining) / TOTAL_TIME) * 100;

      if (isComplete) {
        return (
          <div className="min-h-screen bg-caddi-blue flex flex-col justify-center items-center p-6 success-burst">
            <Confetti active={showConfetti} />
            <div className="text-center max-w-md">
              <div className="text-6xl mb-6">‚ú®</div>
              <h2 className="text-3xl font-black text-white mb-4">Momentum is yours.</h2>
              <p className="text-white opacity-80 mb-8">Inertia broken. The hardest part is done.</p>

              <QuoteDisplay quote={getRandomQuote('completion')} />

              <div className="space-y-3 mt-8">
                <button
                  onClick={() => { haptic(); keepGoing(); }}
                  className="btn-juice w-full py-4 bg-white text-caddi-blue font-bold text-lg rounded-xl shadow-lg"
                >
                  Keep Going? (+{selectedDuration} min)
                </button>
                <button
                  onClick={exitToHome}
                  className="btn-juice w-full py-3 bg-transparent border-2 border-white text-white font-medium rounded-xl"
                >
                  Done for now
                </button>
              </div>
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-caddi-charcoal flex flex-col justify-center items-center p-6 fade-in">
          <button
            onClick={exitToHome}
            className="absolute top-6 left-6 text-caddi-light opacity-50 hover:opacity-100 text-sm font-medium"
          >
            ‚Üê Exit
          </button>
          <SoundToggle isDark={true} />

          <div className="text-center max-w-md w-full">
            <h2 className="text-caddi-purple text-sm font-bold tracking-widest mb-2">IGNITE</h2>

            {/* Duration selector */}
            {!isRunning && (
              <button
                onClick={cycleDuration}
                className="text-caddi-light opacity-60 text-xs mb-4 hover:opacity-100"
              >
                Tap to change: {TIMER_OPTIONS.map(t =>
                  <span key={t} className={t === selectedDuration ? 'text-caddi-purple font-bold' : ''}>
                    {t === selectedDuration ? `[${t}]` : t}
                  </span>
                ).reduce((a, b) => [a, ' / ', b])}
              </button>
            )}

            {/* Timer Display */}
            <div
              onClick={cycleDuration}
              className={`text-9xl font-black text-caddi-light mb-4 tracking-tighter cursor-pointer ${isRunning ? 'glow-pulse' : ''}`}
            >
              {minutes}:{seconds.toString().padStart(2, '0')}
            </div>

            {/* Progress Bar */}
            <div className="w-full h-2 bg-caddi-dark rounded-full overflow-hidden mb-8">
              <div
                className="h-full bg-gradient-to-r from-caddi-purple to-caddi-orange transition-all duration-1000 ease-linear"
                style={{ width: `${progress}%` }}
              />
            </div>

            <QuoteDisplay quote={quote} />

            {!isRunning && (
              <button
                onClick={startTimer}
                className="btn-juice mt-8 w-full py-5 bg-caddi-purple text-white font-bold text-xl rounded-2xl shadow-lg hover:shadow-2xl shimmer"
              >
                üî• Begin ‚Äî No Pause, No Escape
              </button>
            )}

            {isRunning && (
              <p className="mt-8 text-caddi-light opacity-50 text-sm">
                Brown noise active. Just exist with the task.
              </p>
            )}
          </div>
        </div>
      );
    };

    // Fog Cutter View
    const FogCutterView = ({ setMode }) => {
      const [task, setTask] = useState(() => loadState(STORAGE_KEYS.fogcutterTask, ''));
      const [steps, setSteps] = useState(() => loadState(STORAGE_KEYS.fogcutterSteps, []));
      const [currentIndex, setCurrentIndex] = useState(() => loadState(STORAGE_KEYS.fogcutterIndex, 0));
      const [isComplete, setIsComplete] = useState(false);
      const [showConfetti, setShowConfetti] = useState(false);
      const inputRef = useRef(null);

      useEffect(() => { saveState(STORAGE_KEYS.fogcutterTask, task); }, [task]);
      useEffect(() => { saveState(STORAGE_KEYS.fogcutterSteps, steps); }, [steps]);
      useEffect(() => { saveState(STORAGE_KEYS.fogcutterIndex, currentIndex); }, [currentIndex]);

      const generateSteps = () => {
        if (!task.trim()) return;
        const newSteps = breakdownTask(task);
        setSteps(newSteps);
        setCurrentIndex(0);
        haptic();
      };

      const completeStep = () => {
        soundFX.tock();
        haptic([30]);
        if (currentIndex < steps.length - 1) {
          setCurrentIndex(prev => prev + 1);
        } else {
          setIsComplete(true);
          setShowConfetti(true);
          soundFX.chime();
          updateStreak();
          clearModeState();
        }
      };

      const exitToHome = () => {
        clearModeState();
        setMode('home');
      };

      const startOver = () => {
        setTask('');
        setSteps([]);
        setCurrentIndex(0);
        setIsComplete(false);
        setShowConfetti(false);
        inputRef.current?.focus();
      };

      if (isComplete) {
        return (
          <div className="min-h-screen bg-caddi-blue flex flex-col justify-center items-center p-6 success-burst">
            <Confetti active={showConfetti} />
            <div className="text-center max-w-md">
              <div className="text-6xl mb-6">üî™</div>
              <h2 className="text-3xl font-black text-white mb-4">Inertia broken.</h2>
              <p className="text-white opacity-80 mb-8">The fog is cleared. You moved.</p>

              <QuoteDisplay quote={getRandomQuote('completion')} />

              <div className="space-y-3 mt-8">
                <button
                  onClick={() => { haptic(); startOver(); }}
                  className="btn-juice w-full py-4 bg-white text-caddi-blue font-bold text-lg rounded-xl shadow-lg"
                >
                  Break down another task
                </button>
                <button
                  onClick={exitToHome}
                  className="btn-juice w-full py-3 bg-transparent border-2 border-white text-white font-medium rounded-xl"
                >
                  Back to home
                </button>
              </div>
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-caddi-charcoal flex flex-col p-6 fade-in">
          <button
            onClick={exitToHome}
            className="absolute top-6 left-6 text-caddi-light opacity-50 hover:opacity-100 text-sm font-medium"
          >
            ‚Üê Exit
          </button>
          <SoundToggle isDark={true} />

          <div className="max-w-md mx-auto w-full flex-1 flex flex-col justify-center">
            <h2 className="text-caddi-blue text-sm font-bold tracking-widest mb-6 text-center">FOG CUTTER</h2>

            {steps.length === 0 ? (
              <>
                <p className="text-caddi-light text-center mb-6 font-medium">
                  What feels overwhelming right now?
                </p>
                <textarea
                  ref={inputRef}
                  value={task}
                  onChange={(e) => setTask(e.target.value)}
                  placeholder="e.g., Write the quarterly report..."
                  className="w-full p-4 bg-caddi-dark text-caddi-light rounded-xl border-2 border-caddi-blue 
                    focus:border-caddi-blue focus:outline-none resize-none text-lg"
                  rows={3}
                  autoFocus
                />
                <button
                  onClick={generateSteps}
                  disabled={!task.trim()}
                  className="btn-juice mt-4 w-full py-4 bg-caddi-blue text-white font-bold text-lg rounded-xl 
                    disabled:opacity-40 disabled:cursor-not-allowed shadow-lg shimmer"
                >
                  üî™ Cut Through the Fog
                </button>

                <QuoteDisplay quote={getRandomQuote('fogcutter')} />
              </>
            ) : (
              <>
                <p className="text-caddi-light opacity-60 text-sm text-center mb-2">
                  Step {currentIndex + 1} of {steps.length}
                </p>

                {/* Progress Dots */}
                <div className="flex justify-center gap-2 mb-8">
                  {steps.map((_, idx) => (
                    <div
                      key={idx}
                      className={`w-3 h-3 rounded-full transition-all ${idx < currentIndex
                        ? 'bg-caddi-blue'
                        : idx === currentIndex
                          ? 'bg-caddi-blue scale-125'
                          : 'bg-caddi-dark'
                        }`}
                    />
                  ))}
                </div>

                {/* Current Step */}
                <div className="bg-caddi-dark rounded-2xl p-6 mb-6 step-reveal" key={currentIndex}>
                  <p className="text-caddi-light text-xl font-medium leading-relaxed">
                    {steps[currentIndex]}
                  </p>
                </div>

                <button
                  onClick={completeStep}
                  className="btn-juice w-full py-5 bg-caddi-blue text-white font-bold text-xl rounded-2xl shadow-lg"
                >
                  ‚úì Done ‚Äî {currentIndex < steps.length - 1 ? 'Next Step' : 'Finish'}
                </button>
              </>
            )}
          </div>
        </div>
      );
    };

    // Anchor (Breathing) View
    const AnchorView = ({ setMode }) => {
      const [patternKey, setPatternKey] = useState(() =>
        loadState(STORAGE_KEYS.breathingPattern, 'calm')
      );
      const pattern = BREATHING_PATTERNS[patternKey];

      const [phase, setPhase] = useState('ready');
      const [isHolding, setIsHolding] = useState(false);
      const [breathCount, setBreathCount] = useState(0);
      const [countdown, setCountdown] = useState(0);
      const [isComplete, setIsComplete] = useState(false);
      const [showConfetti, setShowConfetti] = useState(false);
      const [quote] = useState(() => getRandomQuote('anchor'));
      const TARGET_BREATHS = 3;

      const circleSize = phase === 'inhale' || phase === 'hold'
        ? 'scale-100'
        : phase === 'exhale' || phase === 'holdAfter'
          ? 'scale-50'
          : 'scale-75';

      const cyclePattern = () => {
        const keys = Object.keys(BREATHING_PATTERNS);
        const idx = keys.indexOf(patternKey);
        const newKey = keys[(idx + 1) % keys.length];
        setPatternKey(newKey);
        saveState(STORAGE_KEYS.breathingPattern, newKey);
        haptic();
      };

      useEffect(() => {
        if (!isHolding && phase !== 'ready' && phase !== 'complete') {
          setPhase('ready');
          setCountdown(0);
        }
      }, [isHolding]);

      useEffect(() => {
        if (!isHolding || phase === 'ready' || phase === 'complete') return;

        if (countdown > 0) {
          const timer = setTimeout(() => setCountdown(c => c - 1), 1000);
          return () => clearTimeout(timer);
        }

        // Phase transitions
        if (phase === 'inhale') {
          if (pattern.hold > 0) {
            setPhase('hold');
            setCountdown(pattern.hold);
          } else {
            setPhase('exhale');
            setCountdown(pattern.exhale);
          }
        } else if (phase === 'hold') {
          setPhase('exhale');
          setCountdown(pattern.exhale);
        } else if (phase === 'exhale') {
          if (pattern.holdAfter) {
            setPhase('holdAfter');
            setCountdown(pattern.holdAfter);
          } else {
            completeCycle();
          }
        } else if (phase === 'holdAfter') {
          completeCycle();
        }
      }, [countdown, phase, isHolding, breathCount, pattern]);

      const completeCycle = () => {
        const newCount = breathCount + 1;
        setBreathCount(newCount);
        soundFX.breathPulse();

        if (newCount >= TARGET_BREATHS) {
          setPhase('complete');
          setIsComplete(true);
          setShowConfetti(true);
          setIsHolding(false);
          soundFX.chime();
          updateStreak();
        } else {
          setPhase('inhale');
          setCountdown(pattern.inhale);
        }
      };

      const startBreathing = () => {
        setIsHolding(true);
        setPhase('inhale');
        setCountdown(pattern.inhale);
        haptic([100]);
      };

      const stopBreathing = () => {
        setIsHolding(false);
      };

      const exitToHome = () => {
        setMode('home');
      };

      const phaseLabels = {
        ready: 'Press and hold to begin',
        inhale: 'Breathe in...',
        hold: 'Hold...',
        exhale: 'Slowly release...',
        holdAfter: 'Hold empty...',
        complete: 'Anchored.',
      };

      if (isComplete) {
        return (
          <div className="min-h-screen bg-caddi-blue flex flex-col justify-center items-center p-6 success-burst">
            <Confetti active={showConfetti} />
            <div className="text-center max-w-md">
              <div className="text-6xl mb-6">‚öì</div>
              <h2 className="text-3xl font-black text-white mb-4">Anchored.</h2>
              <p className="text-white opacity-80 mb-8">You are here. You are now. Continue.</p>

              <QuoteDisplay quote={getRandomQuote('completion')} />

              <div className="space-y-3 mt-8">
                <button
                  onClick={() => {
                    haptic();
                    setPhase('ready');
                    setBreathCount(0);
                    setIsComplete(false);
                    setShowConfetti(false);
                  }}
                  className="btn-juice w-full py-4 bg-white text-caddi-blue font-bold text-lg rounded-xl shadow-lg"
                >
                  Breathe again
                </button>
                <button
                  onClick={exitToHome}
                  className="btn-juice w-full py-3 bg-transparent border-2 border-white text-white font-medium rounded-xl"
                >
                  Back to home
                </button>
              </div>
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-caddi-charcoal flex flex-col justify-center items-center p-6 fade-in">
          <button
            onClick={exitToHome}
            className="absolute top-6 left-6 text-caddi-light opacity-50 hover:opacity-100 text-sm font-medium"
          >
            ‚Üê Exit
          </button>
          <SoundToggle isDark={true} />

          <div className="text-center max-w-md w-full">
            <h2 className="text-caddi-orange text-sm font-bold tracking-widest mb-2">ANCHOR</h2>

            {/* Pattern selector */}
            <button
              onClick={cyclePattern}
              className="text-caddi-light opacity-60 text-xs mb-4 hover:opacity-100"
            >
              {pattern.name} ‚Äî {pattern.description} (tap to change)
            </button>

            <p className="text-caddi-light opacity-60 text-sm mb-2">
              Breath {breathCount + 1} of {TARGET_BREATHS}
            </p>

            {/* Breathing Circle */}
            <div className="relative w-64 h-64 mx-auto my-8 flex items-center justify-center">
              <div
                className={`breathing-circle absolute w-48 h-48 rounded-full bg-gradient-to-br from-caddi-orange to-caddi-purple 
                  opacity-30 blur-xl ${circleSize}`}
                style={{ transitionDuration: phase === 'exhale' ? `${pattern.exhale}s` : phase === 'inhale' ? `${pattern.inhale}s` : '0s' }}
              />
              <div
                className={`breathing-circle w-40 h-40 rounded-full bg-gradient-to-br from-caddi-orange to-caddi-purple 
                  flex items-center justify-center ${circleSize}`}
                style={{ transitionDuration: phase === 'exhale' ? `${pattern.exhale}s` : phase === 'inhale' ? `${pattern.inhale}s` : '0s' }}
              >
                {countdown > 0 && (
                  <span className="text-5xl font-black text-white">{countdown}</span>
                )}
              </div>
            </div>

            <p className="text-caddi-light text-2xl font-bold mb-8">{phaseLabels[phase]}</p>

            {phase === 'ready' ? (
              <button
                onMouseDown={startBreathing}
                onMouseUp={stopBreathing}
                onMouseLeave={stopBreathing}
                onTouchStart={startBreathing}
                onTouchEnd={stopBreathing}
                className="btn-juice w-full py-6 bg-caddi-orange text-white font-bold text-xl rounded-2xl shadow-lg 
                  active:scale-95 shimmer"
              >
                Hold to Breathe
              </button>
            ) : (
              <button
                onMouseDown={() => setIsHolding(true)}
                onMouseUp={stopBreathing}
                onMouseLeave={stopBreathing}
                onTouchStart={() => setIsHolding(true)}
                onTouchEnd={stopBreathing}
                className={`btn-juice w-full py-6 text-white font-bold text-xl rounded-2xl shadow-lg
                  ${isHolding ? 'bg-caddi-orange' : 'bg-caddi-dark border-2 border-caddi-orange'}`}
              >
                {isHolding ? 'Keep holding...' : 'Hold to continue'}
              </button>
            )}

            <QuoteDisplay quote={quote} />
          </div>
        </div>
      );
    };

    // ============================================
    // MAIN APP
    // ============================================
    const App = () => {
      const [mode, setMode] = useState(() => loadState(STORAGE_KEYS.currentMode, 'home'));
      const [isDark, setIsDark] = useState(() => loadState(STORAGE_KEYS.theme, true));
      const [banner, setBanner] = useState(null);

      useEffect(() => {
        notificationManager.setOnDenied((message) => setBanner(message));
        notificationManager.init();
        googleAuth.init();
        offlineSync.flushQueue();
      }, []);

      useEffect(() => {
        saveState(STORAGE_KEYS.currentMode, mode);
      }, [mode]);

      useEffect(() => {
        document.body.className = isDark ? 'dark-theme' : 'light-theme';
        saveState(STORAGE_KEYS.theme, isDark);
      }, [isDark]);

      const toggleTheme = () => {
        setIsDark(!isDark);
        haptic();
      };

      const renderMode = () => {
        switch (mode) {
          case 'ignite':
            return <IgniteView setMode={setMode} />;
          case 'fogcutter':
            return <FogCutterView setMode={setMode} />;
          case 'pomodoro':
            return <PomodoroView setMode={setMode} />;
          case 'brain':
            return <BrainDumpView setMode={setMode} />;
          case 'calendar':
            return <CalendarView setMode={setMode} />;
          case 'anchor':
            return <AnchorView setMode={setMode} />;
          default:
            return <HomeView setMode={setMode} isDark={isDark} toggleTheme={toggleTheme} />;
        }
      };

      return (
        <div className="font-sans antialiased">
          <Banner message={banner} onClose={() => setBanner(null)} />
          {renderMode()}
          <ToastHost />
        </div>
      );
    };

    // ============================================
    // RENDER
    // ============================================
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>

  <script>
    (function registerServiceWorker() {
      if (!('serviceWorker' in navigator)) return;

      const toast = document.getElementById('update-toast');
      const reloadButton = document.getElementById('update-reload');
      let refreshing = false;

      const showToast = (waitingWorker) => {
        if (!toast || !reloadButton) return;
        toast.classList.remove('hidden');
        reloadButton.onclick = () => {
          waitingWorker.postMessage({ type: 'SKIP_WAITING' });
        };
      };

      navigator.serviceWorker.addEventListener('controllerchange', () => {
        if (refreshing) return;
        refreshing = true;
        window.location.reload();
      });

      navigator.serviceWorker
        .register('/sw.js')
        .then((registration) => {
          const listenForWaiting = (worker) => {
            if (worker && worker.state === 'installed') {
              showToast(worker);
            }
          };

          if (registration.waiting) {
            listenForWaiting(registration.waiting);
          }

          registration.addEventListener('updatefound', () => {
            const newWorker = registration.installing;
            if (!newWorker) return;

            newWorker.addEventListener('statechange', () => {
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                listenForWaiting(newWorker);
              }
            });
          });
        })
        .catch(() => {
          // Ignore registration errors to avoid impacting the app experience
        });
    })();
  </script>
</body>

</html>